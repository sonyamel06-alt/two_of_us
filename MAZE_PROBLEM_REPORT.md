# Maze: Problem Report (управление + персонажи)

Дата: 2026-02-08

Этот файл фиксирует текущие наблюдаемые проблемы в игре "Найди друг друга (лабиринт)" и указывает на код, который отвечает за механику/рендер.

## 1) Управление (D-pad): критический баг

### Симптомы (как описано)

1. Первый запуск/первое прохождение уровня:
   - Работают только кнопки **вверх** и **вниз**.
   - При этом они "передвигают по всему полю поочереди" и направление может не соответствовать ожиданию (то есть нажатия не дают точного контроля направления).

2. Второй запуск/второе прохождение:
   - Работают только кнопки **влево** и **вправо**.

### Ожидаемое поведение

- Все 4 кнопки D-pad (up/down/left/right) всегда кликабельны.
- Нажатие конкретной кнопки всегда вызывает соответствующее направление (и только его).

### Фактическое поведение

- После первого прохождения активна только пара кнопок (вертикаль), после второго только другая пара (горизонталь).
- Визуально создается ощущение "переключения режима управления" между попытками.

### Подозреваемые причины (гипотезы)

- Конфликт событий `pointerdown` / `touchstart` / `preventDefault()` на iOS (в зависимости от первого жеста/скролл-блокировки).
- Вариант: элементы D-pad могут перекрываться невидимым слоем (например, canvas/overlay) и принимать события не так, как ожидается.
- Вариант: `PixelPerfectViewport` задает `touch-action: none` на корневом контейнере, что меняет путь обработки касаний.
- Вариант: где-то сохраняется состояние захвата pointer (`setPointerCapture`) или "залипание" active-state, из-за чего события попадают не в тот элемент.

## 2) Персонажи: не видны в статике, "карусель" при движении

### Симптомы (как описано)

- В статичном состоянии **не видно ни player1 (ты), ни player2 (девушка)**.
- Иногда (на долю секунды) при движении видна "карусель" кадров (визуально: быстрые/случайные кадры из 21), после чего персонаж снова пропадает.
- Player1 (ты) "вообще не появляется".

### Ожидаемое поведение

- Player1 всегда виден статичным кадром (анфас).
- Player2 всегда видна; во время движения включается анимация (6-10 fps), после движения остается первый кадр соответствующего направления.
- Никакой "карусели" (рваного/случайного пролистывания кадров).

### Фактическое поведение

- Отрисовка спрайтов нестабильна (в статике отсутствует).
- При движении иногда появляется кратковременная неверная нарезка/отрисовка кадров.

### Подозреваемые причины (гипотезы)

- Изображения спрайтшитов не успевают загрузиться/декодироваться к моменту первой отрисовки, а повторная отрисовка не происходит стабильно.
- Canvas может иметь неправильные размеры/скейл (например, CSS size != canvas buffer), либо не находится поверх grid (z-index/stacking context).
- Возможная проблема индексации кадров (frameIndex -> col/row) или неправильные размеры кадра.
- Возможная проблема с тем, что "рендер" идет в canvas, но canvas либо очищается, либо рисуется не в той системе координат/не в том слое.

## Ссылки на код (текущее состояние)

Основной файл игры (логика, layout, D-pad, победа, рендер спрайтов):
- `src/maze_game.tsx`

Ключевые места (по названиям сущностей внутри файла):
- Компонент `MazeGame`:
  - обработка нажатий направления: функция `tryMove`
  - логика победы: проверка `me2` vs `gfNext`
- Компонент `DPad`:
  - кнопки направления и обработчики `onPointerDown`/`onTouchStart`
- Компонент `MazeSpriteCanvas`:
  - загрузка спрайтшитов (через `loadImage`)
  - основной rAF-рендер `drawSprite(...)`
  - `ctx.imageSmoothingEnabled = false`

Генерация лабиринта:
- `src/utils/mazeGen.ts`

Viewport/скейл и влияние на touch:
- `src/ui/PixelPerfectViewport.tsx`

## Минимальные шаги воспроизведения (как сейчас)

1. Открыть игру, перейти: Меню -> Лабиринт.
2. Попробовать нажимать D-pad:
   - наблюдать, что работают только up/down (1-я попытка).
3. Выйти/перезапустить попытку (или "сыграть заново"), снова попробовать D-pad:
   - наблюдать, что теперь работают только left/right (2-я попытка).
4. Следить за спрайтами на поле:
   - в статике отсутствуют
   - при движении может мелькать "карусель" кадров.

